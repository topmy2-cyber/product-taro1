<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>꿈타로 - 당신의 운명을 비춰보는 거울 | 맞춤형 타로 운세 서비스</title>

<!-- SEO 및 메타 데이터 보강 -->
<meta name="description" content="신비로운 보석 로고와 함께하는 꿈타로에서 당신의 연애운, 올해운, 직업운을 확인하세요. 정교한 알고리즘과 타로의 지혜가 결합된 고품질 운세 리딩을 제공합니다.">
<meta name="keywords" content="타로, 타로운세, 무료타로, 오늘운세, 궁합, 직업운, 연애운, 꿈타로, 인공지능타로, 사주타로">
<meta property="og:title" content="꿈타로 - 당신의 운명을 비춰보는 거울">
<meta property="og:description" content="별의 궤적이 그리는 당신의 운명, 지금 확인해보세요.">
<meta property="og:type" content="website">

<!-- Google AdSense -->
<meta name="google-adsense-account" content="ca-pub-5883207825809699">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5883207825809699"
crossorigin="anonymous"></script>

<!-- Tailwind CSS (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Lucide Icons (CDN) -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* 기본 폰트 및 배경 설정 */
body {
font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
background-color: #020617;
background-image: 
radial-gradient(at 0% 0%, rgba(59, 7, 100, 0.4) 0px, transparent 50%),
radial-gradient(at 50% 0%, rgba(15, 23, 42, 0.8) 0px, transparent 50%),
radial-gradient(at 100% 0%, rgba(88, 28, 135, 0.3) 0px, transparent 50%);
background-attachment: fixed;
color: #f1f5f9;
min-height: 100vh;
margin: 0;
overflow-x: hidden;
}

/* 별빛 반짝임 효과 */
.stars-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: 0;
}
.star {
position: absolute;
background: white;
border-radius: 50%;
opacity: 0.5;
animation: twinkle var(--duration) infinite ease-in-out;
}
@keyframes twinkle {
0%, 100% { opacity: 0.3; transform: scale(1); }
50% { opacity: 1; transform: scale(1.2); }
}

/* 커스텀 라디오 버튼 스타일 */
input[type="radio"]:checked + div {
background-color: rgba(147, 51, 234, 0.5); /* purple-600/50 */
border-color: #fbbf24; /* amber-400 */
color: #fef3c7; /* amber-100 */
}

/* 커스텀 체크박스 스타일 */
input[type="checkbox"]:checked + div {
background-color: #f59e0b; /* amber-500 */
border-color: #f59e0b;
}

/* 언어 전환 버튼 스타일 */
.lang-btn {
transition: all 0.2s;
opacity: 0.5;
cursor: pointer;
}
.lang-btn.active {
opacity: 1;
font-weight: bold;
color: #fbbf24;
border-bottom: 2px solid #fbbf24;
}

/* 화면 전환 애니메이션을 위한 유틸리티 */
.fade-in {
animation: fadeIn 0.5s ease-in-out forwards;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

/* 커스텀 스크롤바 (약관 화면용) */
.custom-scrollbar::-webkit-scrollbar {
width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
background: rgba(30, 41, 59, 0.5);
}
.custom-scrollbar::-webkit-scrollbar-thumb {
background: rgba(147, 51, 234, 0.5);
border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
background: rgba(251, 191, 36, 0.5);
}

/* 토스트 메시지 애니메이션 */
.toast-enter {
animation: slideInRight 0.3s ease-out forwards;
}
.toast-leave {
animation: fadeOut 0.3s ease-in forwards;
}

@keyframes slideInRight {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOut {
from { opacity: 1; }
to { opacity: 0; }
}

/* 카드 덱 전개 및 뽑기 애니메이션을 위한 스타일 */
.tarot-card-deck {
display: flex;
justify-content: center;
flex-wrap: wrap;
padding: 1rem;
max-width: 800px;
margin: 0 auto;
}

.tarot-card-item {
width: 3.5rem;
height: 5.5rem;
margin-left: -3.3rem; /* 78장 배치를 위한 간격 축소 */
border-radius: 0.5rem;
background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%);
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
cursor: pointer;
border: 1px solid #fbbf24;
}

.tarot-card-item:first-child {
margin-left: 0;
}

.tarot-card-item:hover {
transform: translateY(-1rem);
box-shadow: 0 10px 15px -3px rgba(251, 191, 36, 0.5); /* amber 색상 빛망울 */
z-index: 10;
}

.tarot-card-item.drawn {
opacity: 0;
pointer-events: none;
transform: translateY(2rem) scale(0.8);
}

/* 반응형: 태블릿 이상 크기일 때 카드 크기 확대 */
@media (min-width: 768px) {
.tarot-card-item {
width: 4.5rem;
height: 7rem;
margin-left: -4.2rem; /* 78장 배치를 위한 간격 축소 */
}
}

/* 결과 화면의 별 모양 배치를 위한 스타일 */
.star-spread-container {
position: relative;
width: 100%;
max-width: 400px;
aspect-ratio: 1 / 1;
margin: 0 auto;
}

.spread-card {
position: absolute;
transform: translate(-50%, -50%);
width: 4.5rem;
height: 7rem;
transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 타로 카드 앞면 디자인 */
.card-front {
width: 100%;
height: 100%;
background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
border: 2px solid #d4af37; /* 황금색 테두리 */
border-radius: 0.5rem;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
color: #1e293b;
padding: 0.25rem;
text-align: center;
}

/* 5각 별 배치의 좌표 (퍼센트 기반) */
.pos-1 { top: 15%; left: 50%; } /* 꼭대기 */
.pos-2 { top: 40%; left: 85%; } /* 우측 상단 */
.pos-3 { top: 85%; left: 70%; } /* 우측 하단 */
.pos-4 { top: 85%; left: 30%; } /* 좌측 하단 */
.pos-5 { top: 40%; left: 15%; } /* 좌측 상단 */

/* 3장 배열 배치의 좌표 (퍼센트 기반) */
.pos-today-1 { top: 50%; left: 20%; } /* 좌측 (아침) */
.pos-today-2 { top: 50%; left: 50%; } /* 중앙 (낮) */
.pos-today-3 { top: 50%; left: 80%; } /* 우측 (저녁) */

</style>
</head>
<body class="selection:bg-purple-500/30">

<!-- 장식용 별빛 효과 배경 요소들 -->
<div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
<div class="absolute top-10 left-10 w-32 h-32 bg-purple-600/20 rounded-full blur-3xl"></div>
<div class="absolute bottom-10 right-10 w-64 h-64 bg-amber-600/10 rounded-full blur-3xl"></div>
</div>

<!-- 다국어 언어 전환 토글 버튼 (우측 상단 고정) -->
<div class="absolute top-6 right-6 z-50 flex gap-3 text-sm font-medium text-slate-300">
<button id="lang-ko" onclick="setLanguage('ko')" class="lang-btn active pb-1">KR</button>
<span class="text-slate-600">|</span>
<button id="lang-en" onclick="setLanguage('en')" class="lang-btn pb-1">EN</button>
</div>

<!-- 토스트 메시지 컨테이너 -->
<div id="toast-container" class="fixed top-20 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

<!-- 메인 컨텐츠 영역 -->
<div class="relative z-10 w-full">

<!-- ========================================== -->
<!-- 1단계: 로그인 / 회원가입 화면 (auth-screen) -->
<!-- ========================================== -->
<div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen p-4 fade-in">

<div class="text-center mb-8">
<div class="relative flex justify-center items-center mb-8 h-24">
<!-- 몽환적인 배경 오로라 효과 -->
<div class="absolute w-32 h-32 bg-indigo-600/30 rounded-full blur-3xl animate-pulse"></div>
<div class="absolute w-24 h-24 bg-purple-500/20 rounded-full blur-2xl animate-pulse" style="animation-delay: 1s;"></div>

<!-- 입체적인 미래적 보석 로고 (SVG) -->
<div class="relative group scale-110">
<svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-[0_0_30px_rgba(168,85,247,0.8)] filter drop-shadow-lg">
<defs>
<!-- 광원 효과용 그라데이션 -->
<linearGradient id="gemLight" x1="0%" y1="0%" x2="100%" y2="100%">
<stop offset="0%" stop-color="#fef3c7" /> <!-- 빛나는 부분 -->
<stop offset="100%" stop-color="#fbbf24" />
</linearGradient>
<filter id="glow">
<feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
<feMerge>
<feMergeNode in="coloredBlur"/>
<feMergeNode in="SourceGraphic"/>
</feMerge>
</filter>
</defs>

<!-- 8면체 입체 보석 효과 -->
<path d="M50 5 L35 35 L50 50 Z" fill="url(#gemLight)" opacity="0.9" />
<path d="M50 5 L65 35 L50 50 Z" fill="#fbbf24" opacity="0.7" />
<path d="M95 50 L65 35 L50 50 Z" fill="#a855f7" opacity="0.9" />
<path d="M50 95 L65 65 L50 50 Z" fill="#6366f1" opacity="0.9" />

<!-- 중앙 코어 -->
<circle cx="50" cy="50" r="4" fill="white" filter="url(#glow)">
<animate attributeName="r" values="3;5;3" dur="2s" repeatCount="indefinite" />
</circle>
</svg>
</div>
</div>
<h1 class="text-4xl font-bold text-amber-100 mb-2 font-serif tracking-widest" data-i18n="appTitle">꿈타로</h1>
<p class="text-purple-300" data-i18n="appSubtitle">당신의 운명을 비춰보는 신비로운 거울</p>
</div>

<div class="bg-slate-900/80 backdrop-blur-md p-8 rounded-2xl shadow-2xl shadow-purple-900/50 w-full max-w-md border border-purple-500/30">
<!-- 탭 메뉴 -->
<div class="flex mb-6 border-b border-purple-500/30">
<button id="tab-login" onclick="setAuthMode('login')" class="flex-1 pb-3 font-medium transition-colors text-amber-400 border-b-2 border-amber-400" data-i18n="tabLogin">
로그인
</button>
<button id="tab-signup" onclick="setAuthMode('signup')" class="flex-1 pb-3 font-medium transition-colors text-slate-400 hover:text-purple-300" data-i18n="tabSignup">
회원가입
</button>
</div>

<!-- 폼 영역 -->
<form id="auth-form" class="space-y-4">
<div>
<label class="block text-sm font-medium text-purple-300 mb-1" data-i18n="labelEmail">이메일</label>
<input type="email" id="email-input" required class="w-full bg-slate-800 border border-purple-500/50 rounded-lg px-4 py-2 text-amber-100 focus:outline-none focus:border-amber-400 transition-colors" placeholder="email@example.com" />
</div>
<div>
<label class="block text-sm font-medium text-purple-300 mb-1" data-i18n="labelPassword">비밀번호</label>
<input type="password" id="password-input" required class="w-full bg-slate-800 border border-purple-500/50 rounded-lg px-4 py-2 text-amber-100 focus:outline-none focus:border-amber-400 transition-colors" placeholder="••••••••" />
</div>

<!-- 회원가입 시에만 보이는 개인정보 동의 -->
<div id="consent-group" class="pt-2 hidden">
<label class="flex items-start space-x-3 cursor-pointer group">
<div class="flex-shrink-0 mt-0.5 relative">
<input type="checkbox" id="consent-checkbox" class="peer sr-only" />
<div class="w-5 h-5 border-2 border-purple-500/50 rounded peer-checked:bg-amber-500 flex items-center justify-center transition-colors">
<i data-lucide="check" class="w-3 h-3 text-slate-900 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
</div>
</div>
<span class="text-xs text-purple-300 group-hover:text-purple-200 transition-colors" data-i18n="consentText">
[필수] 개인정보 수집 및 이용에 동의합니다.
</span>
</label>
</div>

<button type="submit" id="auth-submit-btn" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-purple-500/50 transition-all flex justify-center items-center" data-i18n="btnSubmitLogin">
운명의 문 열기
</button>
</form>
</div>

<!-- 푸터 -->
<footer class="mt-20 py-8 w-full border-t border-purple-500/10 flex flex-col items-center gap-4 text-xs text-slate-500">
<div class="flex gap-6">
<button onclick="showScreen('privacy-screen')" class="hover:text-amber-400 transition-colors" data-i18n="linkPrivacy">개인정보처리방침</button>
<button onclick="showScreen('terms-screen')" class="hover:text-amber-400 transition-colors" data-i18n="linkTerms">이용약관</button>
<button onclick="showScreen('contact-screen')" class="hover:text-amber-400 transition-colors" data-i18n="btnContact">제휴 및 협업 문의</button>
</div>
<p>© 2026 DreamTarot. All rights reserved.</p>
</footer>
</div>

<!-- ========================================== -->
<!-- 2단계: 프로필 입력 화면 (profile-screen) -->
<!-- ========================================== -->
<div id="profile-screen" class="hidden flex-col items-center justify-center min-h-screen p-4 fade-in">
<div class="bg-slate-900/80 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-purple-500/30">
<h2 class="text-2xl font-bold text-amber-100 mb-6 text-center" data-i18n="profileTitle">당신의 별자리를 찾아서</h2>
<form id="profile-form" class="space-y-6">
<div>
<label class="block text-sm font-medium text-purple-300 mb-2" data-i18n="labelName">이름</label>
<input type="text" id="name-input" required class="w-full bg-slate-800 border border-purple-500/50 rounded-lg px-4 py-3 text-amber-100 focus:outline-none focus:border-amber-400" />
</div>
<div>
<label class="block text-sm font-medium text-purple-300 mb-2" data-i18n="labelBirth">생년월일</label>
<div class="flex gap-2">
<input type="text" id="year-input" placeholder="YYYY" class="w-20 bg-slate-800 border border-purple-500/50 rounded-lg px-2 py-3 text-center text-amber-100" />
<input type="text" id="month-input" placeholder="MM" class="w-14 bg-slate-800 border border-purple-500/50 rounded-lg px-2 py-3 text-center text-amber-100" />
<input type="text" id="day-input" placeholder="DD" class="w-14 bg-slate-800 border border-purple-500/50 rounded-lg px-2 py-3 text-center text-amber-100" />
<select id="calendar-type-input" class="bg-slate-800 border border-purple-500/50 rounded-lg px-2 py-3 text-amber-100"><option value="solar">양력</option><option value="lunar">음력</option></select>
</div>
</div>
<button type="submit" class="w-full bg-amber-600 text-slate-900 font-bold py-3 rounded-lg shadow-lg" data-i18n="btnSubmitProfile">정보 저장 및 시작</button>
</form>
</div>
</div>

<!-- ========================================== -->
<!-- 3단계: 타로 종류 선택 화면 (selection-screen) -->
<!-- ========================================== -->
<div id="selection-screen" class="hidden flex-col items-center justify-center min-h-screen p-4 w-full max-w-4xl mx-auto fade-in">
<h2 class="text-3xl font-bold text-amber-100 mb-8 font-serif"><span id="display-name">여행자</span>님, 환영합니다.</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
<button onclick="selectTarot('today')" class="p-8 bg-slate-900/60 border border-sky-500/30 rounded-2xl hover:bg-sky-900/30 text-center transition-all transform hover:-translate-y-1"><h3 class="text-xl font-bold text-amber-100 mb-2">오늘운 타로</h3><p class="text-sm text-purple-300">운명의 뿌리와 피어나는 파동, 별의 인도를 듣습니다.</p></button>
<button onclick="selectTarot('love')" class="p-8 bg-slate-900/60 border border-rose-500/30 rounded-2xl hover:bg-rose-900/30 text-center transition-all transform hover:-translate-y-1"><h3 class="text-xl font-bold text-amber-100 mb-2">궁합 타로</h3><p class="text-sm text-purple-300">당신과 그 사람을 잇는 인연의 끈을 확인하세요.</p></button>
</div>
<button onclick="handleLogout()" class="mt-12 text-slate-500 hover:text-rose-400 transition-colors">로그아웃</button>
</div>

<!-- 오늘운 질문 입력 화면 -->
<div id="today-profile-screen" class="hidden flex-col items-center justify-center min-h-screen p-4 fade-in">
<div class="bg-slate-900/80 p-8 rounded-2xl w-full max-w-md border border-sky-500/30">
<h2 class="text-2xl font-bold text-amber-100 mb-6 text-center">오늘의 흐름을 묻다</h2>
<form id="today-profile-form" class="space-y-6">
<textarea id="today-question-input" rows="3" class="w-full bg-slate-800 border border-sky-500/50 rounded-lg px-4 py-3 text-amber-100 focus:outline-none" placeholder="오늘 특히 집중하고 싶은 일이나 고민이 있으신가요?"></textarea>
<div class="flex gap-3"><button type="button" onclick="showScreen('selection-screen')" class="w-1/3 bg-slate-800 py-3 rounded-lg text-slate-300">뒤로</button><button type="submit" class="w-2/3 bg-sky-600 py-3 rounded-lg font-bold text-white shadow-lg">운세 보기</button></div>
</form>
</div>
</div>

<!-- 리딩 로딩 화면 -->
<div id="reading-screen" class="hidden flex-col items-center justify-center min-h-screen p-4 text-center fade-in">
<div class="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-6"></div>
<h2 class="text-2xl font-bold text-amber-100 font-serif">타로술사가 기운을 모으고 있습니다...</h2>
</div>

<!-- 카드 뽑기 화면 -->
<div id="draw-screen" class="hidden flex-col items-center justify-center min-h-screen p-4 fade-in">
<h2 id="draw-instruction" class="text-2xl font-bold text-amber-100 mb-8 font-serif"></h2>
<div id="card-deck-container" class="tarot-card-deck mb-12"></div>
<div class="w-full max-w-xl bg-slate-900/60 p-6 rounded-2xl border border-purple-500/30 shadow-2xl"><div id="slots-container" class="flex justify-center gap-4"></div></div>
<div id="result-action-container" class="mt-8 opacity-0 transition-opacity duration-500"><button onclick="showResultScreen()" class="bg-amber-600 text-slate-900 font-bold py-3 px-10 rounded-full shadow-lg">해석 보기</button></div>
</div>

<!-- 결과 화면 -->
<div id="result-screen" class="hidden flex-col items-center py-12 px-4 fade-in w-full max-w-5xl mx-auto">
<div class="star-spread-container mb-12"><div id="spread-svg-container"></div><div id="star-cards-container"></div></div>
<div class="w-full bg-slate-900/80 backdrop-blur-md p-8 md:p-12 rounded-2xl border border-amber-500/30">
<div id="interpretation-content" class="space-y-8 text-slate-200 text-lg leading-relaxed whitespace-pre-line"></div>
<button onclick="showScreen('selection-screen')" class="mt-12 w-full bg-slate-800 py-4 rounded-lg border border-amber-500/30 text-amber-100 font-bold hover:bg-slate-700 transition-colors">새로운 질문하기</button>
</div>
</div>

<!-- 약관 화면들 -->
<div id="privacy-screen" class="hidden p-8 flex-col items-center min-h-screen"><div class="max-w-2xl bg-slate-900 p-8 rounded-xl border border-purple-500/30"><h2 class="text-xl font-bold text-amber-100 mb-4">개인정보처리방침</h2><div class="text-sm text-slate-400">슈파베이스 보안 서버에 안전하게 보관됩니다.</div><button onclick="goBack()" class="mt-8 bg-slate-800 px-8 py-2 rounded-lg">닫기</button></div></div>
<div id="terms-screen" class="hidden p-8 flex-col items-center min-h-screen"><div class="max-w-2xl bg-slate-900 p-8 rounded-xl border border-purple-500/30"><h2 class="text-xl font-bold text-amber-100 mb-4">이용약관</h2><div class="text-sm text-slate-400">본 서비스는 오락용이며 법적 책임을 지지 않습니다.</div><button onclick="goBack()" class="mt-8 bg-slate-800 px-8 py-2 rounded-lg">닫기</button></div></div>
<div id="contact-screen" class="hidden p-8 flex-col items-center min-h-screen"><div class="max-w-2xl bg-slate-900 p-8 rounded-xl border border-purple-500/30"><h2 class="text-xl font-bold text-amber-100 mb-4">제휴 및 협업 문의</h2><form action="https://formspree.io/f/xqedgezb" method="POST" class="space-y-4"><input type="text" name="name" placeholder="성함" class="w-full bg-slate-800 p-3 rounded-lg border border-purple-500/20 text-amber-100" /><textarea name="message" placeholder="내용" class="w-full bg-slate-800 p-3 rounded-lg border border-purple-500/20 text-amber-100"></textarea><button type="submit" class="w-full bg-amber-600 p-3 rounded-lg font-bold text-slate-900">보내기</button></form><button onclick="goBack()" class="mt-4 text-slate-500">닫기</button></div></div>

</div>

<script>
// --- 0. Supabase 설정 ---
const SUPABASE_URL = "https://xqedgezb.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; 
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const uiTranslations = {
appTitle: { ko: "꿈타로", en: "DreamTarot" },
tabLogin: { ko: "로그인", en: "Log In" },
tabSignup: { ko: "회원가입", en: "Sign Up" },
btnSubmitLogin: { ko: "운명의 문 열기", en: "Open the Gate" },
msgDrawInst: { ko: (c) => `마음을 집중해 <strong>${c}장</strong>을 뽑으세요.`, en: (c) => `Focus and draw <strong>${c} cards</strong>.` },
msgDrawDone: { ko: "선택이 완료되었습니다.", en: "Selection complete." },
errConsent: { ko: "개인정보 수집에 동의해주세요.", en: "Please agree to privacy policy." }
};

let currentLang = 'ko';
let currentMode = 'login';
let currentUser = null;
let userInfo = { name: '', birthDate: '', calendarType: 'solar' };
let drawnCardsData = [];
let drawnCardsCount = 0;
let maxDrawCount = 3;
let selectedTarotType = '';

const tarotDatabase = [
{ id: 0, name: { ko: '바보 (The Fool)', en: 'The Fool' }, icon: 'footprints', baseCore: { ko: '새로운 시작과 자유', en: 'New beginnings' } },
{ id: 1, name: { ko: '마법사 (The Magician)', en: 'The Magician' }, icon: 'wand-2', baseCore: { ko: '무한한 잠재력과 의지', en: 'Infinite potential' } },
{ id: 2, name: { ko: '여사제 (The High Priestess)', en: 'The High Priestess' }, icon: 'moon', baseCore: { ko: '깊은 통찰력과 지혜', en: 'Inner wisdom' } },
{ id: 3, name: { ko: '여황제 (The Empress)', en: 'The Empress' }, icon: 'flower', baseCore: { ko: '풍요로움과 모성', en: 'Abundance' } },
{ id: 4, name: { ko: '황제 (The Emperor)', en: 'The Emperor' }, icon: 'crown', baseCore: { ko: '안정과 확고한 기반', en: 'Stability' } }
];

// --- 1. 초기화 및 세션 ---
document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
        currentUser = session.user;
        await loadUserProfile();
        showScreen('selection-screen');
    }
    applyLanguage();
});

function showScreen(id) {
    const screens = ['auth-screen', 'profile-screen', 'selection-screen', 'today-profile-screen', 'reading-screen', 'draw-screen', 'result-screen', 'privacy-screen', 'terms-screen', 'contact-screen'];
    screens.forEach(s => {
        const el = document.getElementById(s);
        if(el) el.classList.add('hidden');
    });
    const target = document.getElementById(id);
    if (target) { target.classList.remove('hidden'); target.classList.add('flex'); }
    if (id === 'selection-screen') document.getElementById('display-name').textContent = userInfo.name || '여행자';
    window.scrollTo(0, 0);
}

function setAuthMode(mode) {
    currentMode = mode;
    document.getElementById('tab-login').className = mode === 'login' ? 'flex-1 pb-3 text-amber-400 border-b-2 border-amber-400 font-bold' : 'flex-1 pb-3 text-slate-400';
    document.getElementById('tab-signup').className = mode === 'signup' ? 'flex-1 pb-3 text-amber-400 border-b-2 border-amber-400 font-bold' : 'flex-1 pb-3 text-slate-400';
    document.getElementById('consent-group').classList.toggle('hidden', mode === 'login');
    document.getElementById('auth-submit-btn').textContent = mode === 'login' ? uiTranslations.btnSubmitLogin[currentLang] : '여정 시작하기';
}

// --- 2. 인증 및 데이터 처리 ---
document.getElementById('auth-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email-input').value;
    const password = document.getElementById('password-input').value;

    if (currentMode === 'signup') {
        if (!document.getElementById('consent-checkbox').checked) return alert(uiTranslations.errConsent[currentLang]);
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) return alert(error.message);
        currentUser = data.user;
        showScreen('profile-screen');
    } else {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) return alert("인증 실패: 정보를 확인해주세요.");
        currentUser = data.user;
        await loadUserProfile();
        showScreen(userInfo.name ? 'selection-screen' : 'profile-screen');
    }
});

async function loadUserProfile() {
    if (!currentUser) return;
    const { data } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
    if (data) {
        userInfo = { name: data.name, birthDate: data.birth_date, calendarType: data.calendar_type };
    }
}

document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('name-input').value;
    const year = document.getElementById('year-input').value;
    const month = document.getElementById('month-input').value;
    const day = document.getElementById('day-input').value;
    const birth_date = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
    const calendar_type = document.getElementById('calendar-type-input').value;

    const { error } = await supabaseClient.from('profiles').upsert({ id: currentUser.id, name, birth_date, calendar_type });
    if (!error) {
        userInfo = { name, birthDate: birth_date, calendarType: calendar_type };
        showScreen('selection-screen');
    }
});

// --- 3. 타로 해석 로직 (AI Edge Function) ---
async function fetchAIInterpretation(cards, user, type, contextInfo) {
    const previousId = localStorage.getItem('lastInteractionId');
    try {
        const { data, error } = await supabaseClient.functions.invoke('generate-tarot', {
            body: { 
                cards, user, type, 
                contextInfo, previousId,
                lang: currentLang
            }
        });
        if (error) throw error;
        return data;
    } catch (e) {
        console.warn("AI 실패:", e);
        return null;
    }
}

async function showResultScreen() {
    showScreen('result-screen');
    const content = document.getElementById('interpretation-content');
    content.innerHTML = `<div class="flex flex-col items-center py-12"><div class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-amber-200 animate-pulse">타로술사가 당신의 기운을 읽으며<br/>별의 속삭임을 정리하고 있습니다...</p></div>`;

    const contextInfo = selectedTarotType === 'today' ? { question: document.getElementById('today-question-input').value } : {};
    const aiResult = await fetchAIInterpretation(drawnCardsData, userInfo, selectedTarotType, contextInfo);

    content.innerHTML = ''; 

    if (aiResult && aiResult.mainInterpretation) {
        content.innerHTML = aiResult.mainInterpretation.replace(/\n/g, '<br/>');
        if (aiResult.interactionId) localStorage.setItem('lastInteractionId', aiResult.interactionId);
    } else {
        renderLocalFallback();
    }
}

function renderLocalFallback() {
    const content = document.getElementById('interpretation-content');
    const titles = selectedTarotType === 'today' ? ["✦ 태초의 기운", "✦ 전개되는 흐름", "✦ 하늘의 계시"] : ["현재", "과제", "과거", "미래", "조언"];
    drawnCardsData.forEach((card, i) => {
        const div = document.createElement('div');
        div.className = 'bg-slate-800/40 p-6 rounded-xl border border-purple-500/10 mb-6';
        div.innerHTML = `<h4 class="text-amber-300 font-bold mb-3 text-xl">${titles[i]}</h4><p class="leading-relaxed">선택하신 '${card.name[currentLang]}' 카드는 현재 [${card.baseCore[currentLang]}]의 의미를 가집니다.<br/><br/><span class="text-amber-400 font-bold">이 상황을 인지하고 행동하는 것이 오늘의 핵심입니다.</span></p>`;
        content.appendChild(div);
    });
}

// --- 4. 기타 로직 ---
function selectTarot(type) {
    selectedTarotType = type;
    maxDrawCount = (type === 'today') ? 3 : 5;
    showScreen(type === 'today' ? 'today-profile-screen' : 'reading-screen');
    if (type !== 'today') { setTimeout(() => { initDrawScreen(); showScreen('draw-screen'); }, 2000); }
}

document.getElementById('today-profile-form').addEventListener('submit', (e) => {
    e.preventDefault();
    showScreen('reading-screen');
    setTimeout(() => { initDrawScreen(); showScreen('draw-screen'); }, 2000);
});

function initDrawScreen() {
    drawnCardsCount = 0; drawnCardsData = [];
    const deck = document.getElementById('card-deck-container');
    const slots = document.getElementById('slots-container');
    deck.innerHTML = ''; slots.innerHTML = '';
    document.getElementById('draw-instruction').innerHTML = uiTranslations.msgDrawInst[currentLang](maxDrawCount);
    document.getElementById('result-action-container').style.opacity = '0';

    for (let i = 1; i <= maxDrawCount; i++) {
        slots.innerHTML += `<div id="slot-${i}" class="w-14 h-20 md:w-20 md:h-32 border-2 border-dashed border-purple-500/30 rounded-lg"></div>`;
    }
    for (let i = 0; i < 22; i++) {
        const card = document.createElement('div');
        card.className = 'tarot-card-item';
        card.onclick = function() {
            if (drawnCardsCount < maxDrawCount && !this.classList.contains('drawn')) {
                this.classList.add('drawn');
                drawnCardsCount++;
                const cardData = tarotDatabase[Math.floor(Math.random() * tarotDatabase.length)];
                drawnCardsData.push(cardData);
                const slot = document.getElementById(`slot-${drawnCardsCount}`);
                slot.className = 'w-14 h-20 md:w-20 md:h-32 bg-amber-900/40 border border-amber-400/50 rounded-lg flex items-center justify-center text-[10px] font-bold text-amber-100 px-1 text-center';
                slot.innerHTML = cardData.name[currentLang];
                if (drawnCardsCount === maxDrawCount) {
                    document.getElementById('result-action-container').style.opacity = '1';
                }
            }
        };
        deck.appendChild(card);
    }
}

function setLanguage(lang) {
    currentLang = lang;
    applyLanguage();
    document.getElementById('lang-ko').classList.toggle('active', lang === 'ko');
    document.getElementById('lang-en').classList.toggle('active', lang === 'en');
}

function applyLanguage() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (uiTranslations[key]) el.textContent = typeof uiTranslations[key][currentLang] === 'function' ? uiTranslations[key][currentLang](maxDrawCount) : uiTranslations[key][currentLang];
    });
}

async function handleLogout() { await supabaseClient.auth.signOut(); location.reload(); }
function goBack() { showScreen('auth-screen'); }
</script>
</body>
</html>